# AI Otoscope  

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ **–ò–ò-–û—Ç–æ—Å–∫–æ–ø**.  
–°–∏—Å—Ç–µ–º–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–æ—Å–∫–æ–ø–∏–∏.  
–¶–µ–ª—å ‚Äî –ø–æ–º–æ—â—å –≤—Ä–∞—á—É –≤ –≤—ã—è–≤–ª–µ–Ω–∏–∏ –ø–∞—Ç–æ–ª–æ–≥–∏–π —É—Ö–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–µ—Ç–æ–¥–æ–≤ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. 

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# 1) —Å–æ–∑–¥–∞—Ç—å –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ (Python 3.12 –æ–∫)
python3.12 -m venv otoscope
source otoscope/bin/activate

# 2) –æ–±–Ω–æ–≤–∏—Ç—å pip
pip install --upgrade pip

# 3) Linux + Nvidia GPU (Cuda 12.1)
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121

# 4) –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
pip install -r requirements.txt
```


## –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–Ω—Å–∞–º–±–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∞—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ **timm**.  

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è `x`:  
- –∫–∞–∂–¥–∞—è –º–æ–¥–µ–ª—å `m` –≤—ã—á–∏—Å–ª—è–µ—Ç –≤–µ–∫—Ç–æ—Ä –ª–æ–≥–∏—Ç–æ–≤ `z^(m)` —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ `C` (—á–∏—Å–ª–æ –∫–ª–∞—Å—Å–æ–≤);  
- –ª–æ–≥–∏—Ç—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è –≤ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ —Å–∏–≥–º–æ–∏–¥—É: `p^(m) = sigmoid(z^(m))`;  
- —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞–±–æ—Ä –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: `p^(1), p^(2), ..., p^(M)`;  

–î–∞–ª–µ–µ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:  
- **—Å—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –ø–æ –≤—Å–µ–º –º–æ–¥–µ–ª—è–º;  
- **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ**: –º–µ—Ä–∞ —Ä–∞–∑–±—Ä–æ—Å–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏ (–æ—Ü–µ–Ω–∫–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏);  
- **—Å—Ä–µ–¥–Ω–∏–µ –ª–æ–≥–∏—Ç—ã**: –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∏—Ç–æ–≥–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è.  

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–æ–¥–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:  
- –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –∫–∞–∂–¥–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã,  
- —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ (–æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∞–Ω—Å–∞–º–±–ª—è),  
- —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π (–¥–ª—è –æ—Ü–µ–Ω–∫–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏),  
- —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω—ã–µ –ª–æ–≥–∏—Ç—ã (–¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å).  

–ê–Ω—Å–∞–º–±–ª—å –ø–æ–≤—ã—à–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ—à–∏–±–∫–∞–º –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª—É—á—à–µ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π.

## –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ú–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏.  

- **–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö**: RGB-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.  
- **–†–∞–∑–º–µ—Ä**: `224 √ó 224` –ø–∏–∫—Å–µ–ª–µ–π (–∫–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ —ç—Ç–æ–º—É —Ä–∞–∑–º–µ—Ä—É –ø—Ä–∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–µ).  
- **–§–æ—Ä–º–∞—Ç —Ç–µ–Ω–∑–æ—Ä–∞**: `FloatTensor` —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ `[B, 3, 224, 224]`,  
  –≥–¥–µ  
  - `B` ‚Äî —Ä–∞–∑–º–µ—Ä batch (—á–∏—Å–ª–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø–∞–∫–µ—Ç–µ),  
  - `3` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤ (RGB),  
  - `224 √ó 224` ‚Äî –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã.  
- **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è**: –∑–Ω–∞—á–µ–Ω–∏—è –ø–∏–∫—Å–µ–ª–µ–π –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É `[0, 1]` –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è  
  (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è mean/std –∏–∑ ImageNet).

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
import torch
from PIL import Image
from torchvision import transforms
from model import EnsembleModel  # –∏–º–ø–æ—Ä—Ç —Ç–≤–æ–µ–π –º–æ–¥–µ–ª–∏

# 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
image = Image.open("example.jpg").convert("RGB")

# 2. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è (resize + —Ç–µ–Ω–∑–æ—Ä + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è)
transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize(
        mean=[0.485, 0.456, 0.406],  # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ ImageNet mean
        std=[0.229, 0.224, 0.225]    # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ ImageNet std
    )
])
x = transform(image).unsqueeze(0)   # —Ä–∞–∑–º–µ—Ä [1, 3, 224, 224]

# 3. –ü—Ä–æ–≥–æ–Ω —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å
model = EnsembleModel(num_classes=5)
logits_stack, probs_stack, avg_probs, std_probs, avg_logits = model(x)

print("–§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞:", x.shape)           # torch.Size([1, 3, 224, 224])
print("–§–æ—Ä–º–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π:", avg_probs.shape)  # torch.Size([1, 5])
```
## –ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –∏ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞

### –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏
–ú–æ–¥–µ–ª—å —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á—É **–º–Ω–æ–≥–æ–º–µ—Ç–æ—á–Ω–æ–π (multi-label) –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—Ö–∞. –ù–∞ –≤—ã—Ö–æ–¥–µ ‚Äî –ø–æ –æ–¥–Ω–æ–º—É –ª–æ–≥–∏—Ç—É/–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –∏–∑ `C` –∫–ª–∞—Å—Å–æ–≤ (–≤ –∫–æ–¥–µ `num_classes=5`). –ê–Ω—Å–∞–º–±–ª—å –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥–µ–ª–µ–π –∏–∑ `timm` –∏ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∏—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–Ω—Å–∞–º–±–ª–µ–≤–∞—è –æ–±—ë—Ä—Ç–∫–∞ `EnsembleModel` —Å `M` –±–∞–∑–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏ (–≤ –∫–æ–¥–µ –∞–∫—Ç–∏–≤–µ–Ω `beit3_large_patch16_224`, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é). –î–ª—è –≤—Ö–æ–¥–Ω–æ–≥–æ –±–∞—Ç—á–∞ `x` –∫–∞–∂–¥–∞—è –º–æ–¥–µ–ª—å –≤—ã–¥–∞—ë—Ç –ª–æ–≥–∏—Ç—ã `z^(m)`. –î–∞–ª–µ–µ:
- —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ `p^(m) = sigmoid(z^(m))`;
- –ø–æ –∞–Ω—Å–∞–º–±–ª—é —Å—á–∏—Ç–∞—é—Ç—Å—è **—Å—Ä–µ–¥–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏** `avg_probs` (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–µ–¥–∏–∫—Ç–æ—Ä –Ω–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–µ),
- **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ** `std_probs` (–æ—Ü–µ–Ω–∫–∞ —Ä–∞–∑–±—Ä–æ—Å–∞/–Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏),
- **—Å—Ä–µ–¥–Ω–∏–µ –ª–æ–≥–∏—Ç—ã** `avg_logits` (—É–¥–æ–±–Ω—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å).

–í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è: —Å—Ç–µ–∫–∏ –ª–æ–≥–∏—Ç–æ–≤/–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –ø–æ –º–æ–¥–µ–ª—è–º, –∞ —Ç–∞–∫–∂–µ `avg_probs`, `std_probs`, `avg_logits`.

### –î–∞–Ω–Ω—ã–µ –∏ —Å–ø–ª–∏—Ç
–ò–∑ Excel-—Ç–∞–±–ª–∏—Ü—ã –æ—Ç–±–∏—Ä–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ —Å –≤–∞–ª–∏–¥–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º (`"–§–∏–Ω–∞–ª –ö–∞—á–µ—Å—Ç–≤–æ" != "–Ω–µ—Ç"`), –ø–æ—Å–ª–µ —á–µ–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ `train/val` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 80/20, `random_state=1`).  
–í—Ö–æ–¥ ‚Äî RGB-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø—Ä–∏–≤–æ–¥–∏–º—ã–µ –∫ `224√ó224`.

### –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
- **Train**: Resize(224,224), HorizontalFlip, Rotation(¬±15¬∞), ColorJitter (—è—Ä–∫–æ—Å—Ç—å/–∫–æ–Ω—Ç—Ä–∞—Å—Ç/–Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å), GaussianBlur (–ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏), ToTensor, RandomErasing (–ø–æ—Å–ª–µ ToTensor), Normalize (ImageNet mean/std).
- **Val**: Resize(224,224), ToTensor, Normalize (ImageNet mean/std).

### –§—É–Ω–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—å –∏ –¥–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤
–¢–∞–∫ –∫–∞–∫ –∑–∞–¥–∞—á–∞ –º–Ω–æ–≥–æ–º–µ—Ç–æ—á–Ω–∞—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **`BCEWithLogitsLoss`**. –î–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è `pos_weight` –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∞—Å—Ç–æ—Ç—ã –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–ª–∞—Å—Å—É –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –ª–æ—Å—Å.  
–í –∫–æ–¥–µ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:
- –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è BCE –ø–æ –∫–ª–∞—Å—Å–∞–º (`WeightedBCEWithLogitsLoss`),
- –≥–∏–±—Ä–∏–¥ BCE + Focal (`MixedLoss` —Å `BinaryFocalLoss`) ‚Äî —É–¥–æ–±–Ω–æ –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –¥–∏—Å–±–∞–ª–∞–Ω—Å–µ.

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∫–æ–¥–µ)
- –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä: **AdamW**, `lr=5e-6`, `weight_decay=1e-4`.
- –ë–∞—Ç—á-—Ä–∞–∑–º–µ—Ä: `2` –¥–ª—è –æ–±—É—á–µ–Ω–∏—è, `1` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
- –≠–ø–æ—Ö–∏: `50` (early stopping –Ω–µ –≤–∫–ª—é—á—ë–Ω; —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –ø–æ –ª—É—á—à–µ–º—É —Å–∫–æ—Ä—É).
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: `cuda:2` –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ GPU.

### –ö—Ä–∏—Ç–µ—Ä–∏–π –æ—Ç–±–æ—Ä–∞ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏
–ù–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è **Precision, Recall (Sensitivity), Specificity, F1** –ø—Ä–∏ –ø–æ—Ä–æ–≥–µ `0.5` –Ω–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è—Ö `sigmoid(avg_logits)`.  
–ö–ª—é—á–µ–≤–æ–π —Å–∫–æ—Ä ‚Äî **—Å—Ä–µ–¥–Ω–∏–π F1** –ø–æ —Ü–µ–ª–µ–≤—ã–º –∫–ª–∞—Å—Å–∞–º `['–æ—Ç–∏—Ç –≥–Ω–æ–π–Ω—ã–π', '–æ—Ç–∏—Ç –Ω–µ–≥–Ω–æ–π–Ω—ã–π']`. –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Å—Ä–µ–¥–Ω–∏–π F1 —É–ª—É—á—à–∞–µ—Ç—Å—è, –≤–µ—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `weights6/best_ensemble_model{epoch}.pth`.

> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø–æ—Ä–æ–≥ `0.5` –≤—ã–±—Ä–∞–Ω –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö –∫–ª–∞—Å—Å–æ–≤. –î–ª—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–µ—Ç —Å–º—ã—Å–ª **–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –ø–æ—Ä–æ–≥–∏ –ø–æ –∫–ª–∞—Å—Å–∞–º** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –º–∞–∫—Å–∏–º—É–º—É F1/Youden J –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏), –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –Ω–µ—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã—Ö –∏–∑–¥–µ—Ä–∂–∫–∞—Ö –æ—à–∏–±–æ–∫.

### –ò–Ω—Ñ–µ—Ä–µ–Ω—Å
–ù–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –∞–Ω—Å–∞–º–±–ª—è:
1) –ø—Ä–æ–≥–æ–Ω –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏;
2) —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ (–ø–æ –º–æ–¥–µ–ª—è–º) ‚Äî –ª–∏–±–æ –ª–æ–≥–∏—Ç–æ–≤ —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º `sigmoid(avg_logits)`, –ª–∏–±–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π `avg_probs`;
3) –ø–æ–ª—É—á–µ–Ω–∏–µ –º–Ω–æ–≥–æ–º–µ—Ç–æ—á–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏ –ø–æ –ø–æ—Ä–æ–≥–∞–º (–≤ –∫–æ–¥–µ ‚Äî 0.5).  
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `std_probs` –∫–∞–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä **–Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏**: –≤—ã—Å–æ–∫–∏–π —Ä–∞–∑–±—Ä–æ—Å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞/–≤—Ç–æ—Ä–æ–≥–æ –º–Ω–µ–Ω–∏—è.

### –ú–µ—Ç—Ä–∏–∫–∏ –æ—Ç—á—ë—Ç–∞
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤—ã–≤–æ–¥—è—Ç—Å—è:
- **Precision**, **Recall (Sensitivity)**, **Specificity**, **F1**,
–∞ —Ç–∞–∫–∂–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –ø–æ —Ü–µ–ª–µ–≤–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É F1.

### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞ (–ø–æ—á–µ–º—É —Ç–∞–∫)
- **–ê–Ω—Å–∞–º–±–ª—å** —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä –∏ –≤—ã–¥–∞—ë—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–π –ø—Ä–æ–≥–Ω–æ–∑; `std_probs` –¥–∞—ë—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏.
- **BCEWithLogits + pos_weight** ‚Äî –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è multi-label; –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (Focal/Mixed) –ø–æ–ª–µ–∑–Ω—ã –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –¥–∏—Å–±–∞–ª–∞–Ω—Å–µ –∏–ª–∏ –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –ª—ë–≥–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤.
- **–ñ—ë—Å—Ç–∫–∏–π –æ–±—â–∏–π –ø–æ—Ä–æ–≥ 0.5** ‚Äî –±–∞–∑–æ–≤—ã–π —Å—Ç–∞—Ä—Ç, –Ω–æ **–∫–ª–∞—Å—Å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–æ–≤** –æ–±—ã—á–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –æ—â—É—Ç–∏–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏.

## –ò–Ω—Ñ–µ—Ä–µ–Ω—Å

–ò–Ω—Ñ–µ—Ä–µ–Ω—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞ `inference/inference_test.py`.  
–û–Ω –ø—Ä–æ–≥–æ–Ω—è–µ—Ç –º–æ–¥–µ–ª—å –ø–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å GT-—Ç–∞–±–ª–∏—Ü–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∏ –º–µ—Ç—Ä–∏–∫–∏.

### –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**: RGB, –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å `study_id` –≤ GT-—Ç–∞–±–ª–∏—Ü–µ.  
- **GT-—Ç–∞–±–ª–∏—Ü–∞**: CSV –∏–ª–∏ Excel —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: study_id, NORM, OP, ONP, CI, OTH
–≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏—è `0/1` —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞–ª–∏—á–∏–µ –∫–ª–∞—Å—Å–∞:
- `NORM` ‚Äî –Ω–æ—Ä–º–∞  
- `OP` ‚Äî –æ—Å—Ç—Ä—ã–π –≥–Ω–æ–π–Ω—ã–π –æ—Ç–∏—Ç  
- `ONP` ‚Äî –æ—Å—Ç—Ä—ã–π –Ω–µ–≥–Ω–æ–π–Ω—ã–π –æ—Ç–∏—Ç  
- `CI` ‚Äî —Å–µ—Ä–Ω–∞—è –ø—Ä–æ–±–∫–∞  
- `OTH` ‚Äî –¥—Ä—É–≥–∏–µ –ø–∞—Ç–æ–ª–æ–≥–∏–∏
### –ó–∞–ø—É—Å–∫
```bash
python inference_test.py \
--images_dir /path/to/–£—à–∏ \
--gt_csv /path/to/gt_converted_test.csv \
--weights /path/to/best_ensemble_model33.pth \
--out_preds_csv "outputs/preds.csv" \
--metrics_csv "outputs/metrics.csv" \
--auto_tune_otitis \
--r_min 0.80 \
--p_min 0.80 \
--norm_veto_th 0.90 \
--sulfur_veto_th 0.85 \
--ng_margin 0.10 \
--device cuda:0 \
--batch_size 1
```
### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ GT-—Ç–∞–±–ª–∏—Ü—É.  
2. –ü—Ä–æ–≥–æ–Ω—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∞–Ω—Å–∞–º–±–ª–µ–≤—É—é –º–æ–¥–µ–ª—å (**EnsembleModel**).  
3. –°—á–∏—Ç–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ (`sigmoid(avg_logits)`), –±–∏–Ω–∞—Ä–∏–∑—É–µ—Ç –ø–æ –ø–æ—Ä–æ–≥–∞–º.  
4. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫—É:  
   - **veto –Ω–æ—Ä–º–æ–π** (`--norm_veto_th`) ‚Äî –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –Ω–æ—Ä–º–µ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞, —Ç–æ –≥–Ω–æ–π–Ω—ã–π –æ—Ç–∏—Ç –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è.  
   - **veto —Å–µ—Ä–Ω–æ–π –ø—Ä–æ–±–∫–æ–π** (`--sulfur_veto_th`) ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è CI.  
   - **–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–µ–≥–Ω–æ–π–Ω–æ–≥–æ** (`--ng_margin`) ‚Äî –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã –æ–±–∞ –æ—Ç–∏—Ç–∞, –Ω–æ –Ω–µ–≥–Ω–æ–π–Ω—ã–π –∑–∞–º–µ—Ç–Ω–æ —Å–∏–ª—å–Ω–µ–µ, —Ç–æ –≥–Ω–æ–π–Ω—ã–π –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è.  
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∏ –º–µ—Ç—Ä–∏–∫–∏.  

### –§–æ—Ä–º–∞—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
CSV (`out_preds_csv`) –∏–º–µ–µ—Ç –≤–∏–¥:
study_id,norm,op,onp,ci,oth

IMG_001.jpg,1,0,0,0,0

IMG_002.jpg,0,1,0,0,0

IMG_003.jpg,0,0,1,0,0

IMG_004.jpg,0,0,0,1,0

### –§–æ—Ä–º–∞—Ç –º–µ—Ç—Ä–∏–∫
CSV (`metrics_csv`) —Å–æ–¥–µ—Ä–∂–∏—Ç:
class,threshold,precision,recall,specificity,f1,accuracy

NORM,0.500,0.900,0.970,0.876,0.934,0.927

OP,0.019,0.868,0.805,0.985,0.835,0.966

ONP,0.208,0.814,0.838,0.958,0.826,0.937

CI,0.500,0.879,0.967,0.989,0.921,0.987

OTH,0.500,0.509,0.643,0.923,0.568,0.892


### –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ–ª–∞–≥–∏
- `--auto_tune_otitis` ‚Äî —Ç—é–Ω–∏–Ω–≥ –ø–æ—Ä–æ–≥–æ–≤ OP/ONP –ø–æ–¥ Recall ‚â• `r_min` –∏ Precision ‚â• `p_min`.  
- `--norm_veto_th` ‚Äî –ø–æ—Ä–æ–≥ veto –Ω–æ—Ä–º–æ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.90`).  
- `--sulfur_veto_th` ‚Äî –ø–æ—Ä–æ–≥ veto —Å–µ—Ä–Ω–æ–π –ø—Ä–æ–±–∫–æ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.85`).  
- `--ng_margin` ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–µ–≥–Ω–æ–π–Ω–æ–≥–æ –æ—Ç–∏—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.10`).

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ —Å –ø–∞–ø–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π `data/–£—à–∏` –∏ GT-—Ç–∞–±–ª–∏—Ü–µ–π `data/gt_converted_test.csv` –Ω–∞ –≤—ã—Ö–æ–¥–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å—Å—è –º–µ—Ç—Ä–∏–∫–∏:  

### üìä Metrics (per class)

| Class       | Prec | Rec  | Spec | F1   | Acc  | Thr   |
|-------------|------|------|------|------|------|-------|
| NORM        | 0.900 | 0.970 | 0.876 | 0.934 | 0.927 | 0.500 |
| OP *(tuned)*| 0.868 | 0.805 | 0.985 | 0.835 | 0.966 | 0.019 |
| ONP *(tuned)*| 0.814 | 0.838 | 0.958 | 0.826 | 0.937 | 0.208 |
| CI          | 0.879 | 0.967 | 0.989 | 0.921 | 0.987 | 0.500 |
| OTH         | 0.509 | 0.643 | 0.923 | 0.568 | 0.892 | 0.500 |
  
